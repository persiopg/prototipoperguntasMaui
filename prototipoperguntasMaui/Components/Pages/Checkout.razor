@page "/checkout/{StoreId:int?}"
@using prototipoperguntasMaui.Services
@inject AppStateService AppState
@inject NavigationManager Nav
@inject IJSRuntime JS

<div class="mobile-container p-5">
    <div class="sticky top-0 bg-white z-40 pb-4">
        <div class="flex items-center gap-3 mb-3">
            <button @onclick="BackToStore" class="text-slate-600"><i class="fa-solid fa-chevron-left"></i></button>
            <h2 class="font-bold text-lg">Checkout</h2>
        </div>
    </div>

    <div class="mt-4">
        <div class="section-header text-slate-500"><i class="fa-solid fa-comment-dots"></i> Observações Gerais</div>
        <div class="app-card">
            <textarea rows="6" @bind="AppState.TempExecution.GeneralNotes" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-4 text-sm text-slate-700 focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-100 transition" placeholder="Detalhe aqui as observações gerais da visita..."></textarea>
        </div>

        <div class="section-header text-slate-800 mt-6"><i class="fa-solid fa-file-signature"></i> Assinatura</div>
        <div class="app-card">
            <p class="text-xs text-slate-500 mb-2">Solicite a assinatura do responsável pelo PDV:</p>
            <div class="border-2 border-dashed border-slate-300 rounded-xl bg-slate-50 relative overflow-hidden touch-none" style="height: 220px;">
                <canvas id="checkout-signature-pad" class="w-full h-full block"></canvas>
                <div class="absolute bottom-2 right-2 text-[9px] text-slate-400 pointer-events-none">Assine aqui</div>
            </div>

            <div class="mt-3 flex gap-3">
                <button @onclick="ClearSignature" class="text-xs text-red-500 font-bold hover:underline flex items-center gap-1">
                    <i class="fa-solid fa-eraser"></i> Limpar
                </button>
                <button @onclick="SaveSignature" class="ml-auto bg-blue-600 text-white font-bold py-2.5 px-4 rounded-xl shadow hover:bg-blue-700 transition">Salvar Assinatura</button>
            </div>

            @if (!string.IsNullOrWhiteSpace(AppState.TempExecution.SignatureBase64))
            {
                <div class="mt-4">
                    <div class="text-[10px] font-bold text-slate-400 mb-2">Pré-visualização</div>
                    <img src="@AppState.TempExecution.SignatureBase64" class="h-24 rounded-lg border border-slate-100 object-contain" />
                </div>
            }
        </div>

        <div class="mt-6">
            <button @onclick="FinalizeVisitAsync" class="w-full bg-green-600 text-white font-black py-3 rounded-xl shadow hover:bg-green-700 transition">Finalizar Visita</button>
        </div>
    </div>

    @if (ShowDialog)
    {
        <div class="fixed inset-0 bg-slate-900/80 z-[80] flex items-center justify-center p-6 backdrop-blur-md">
            <div class="bg-white rounded-3xl shadow-2xl w-full max-w-sm overflow-hidden transform transition-all scale-100 animate-[fadeIn_0.2s_ease-out]">
                <div class="p-8 text-center">
                    <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-blue-50 mb-6 shadow-inner">
                        <i class="fa-solid fa-circle-info text-blue-600 text-3xl"></i>
                    </div>
                    <h3 class="text-xl font-black text-slate-900 mb-2">Atenção</h3>
                    <p class="text-sm text-slate-500 leading-relaxed">@DialogMessage</p>
                </div>
                <div class="bg-slate-50 px-6 py-4 flex gap-3 justify-center border-t border-slate-100">
                    @if (DialogIsConfirm)
                    {
                        <button type="button" @onclick="DialogCancel" class="flex-1 justify-center rounded-xl border border-slate-300 px-4 py-3 bg-white text-sm font-bold text-slate-700 hover:bg-slate-50 focus:outline-none transition">Cancelar</button>
                        <button type="button" @onclick="DialogConfirm" class="flex-1 justify-center rounded-xl border border-transparent px-4 py-3 bg-blue-600 text-sm font-bold text-white hover:bg-blue-700 focus:outline-none shadow-lg shadow-blue-200 transition">Confirmar</button>
                    }
                    else
                    {
                        <button type="button" @onclick="DialogCancel" class="flex-1 justify-center rounded-xl border border-transparent px-4 py-3 bg-blue-600 text-sm font-bold text-white hover:bg-blue-700 focus:outline-none shadow-lg shadow-blue-200 transition">OK</button>
                    }
                </div>
            </div>
        </div>
    }
</div>

@code {
    [Parameter] public int? StoreId { get; set; }

    private bool ShowDialog = false;
    private bool DialogIsConfirm = false;
    private string DialogMessage = string.Empty;
    private Action? OnDialogConfirm;

    private async Task SaveSignature()
    {
        try
        {
            var dataUrl = await JS.InvokeAsync<string>("signature.getDataUrl", "checkout-signature-pad");
            if (!string.IsNullOrWhiteSpace(dataUrl))
            {
                AppState.TempExecution.SignatureBase64 = dataUrl;
                StateHasChanged();
            }
            else
            {
                ShowAlert("Assinatura não detectada. Assine no campo antes de salvar.");
            }
        }
        catch (Exception ex)
        {
            ShowAlert($"Erro ao salvar assinatura: {ex.Message}");
        }
    }

    private async Task ClearSignature()
    {
        try
        {
            await JS.InvokeVoidAsync("signature.clear", "checkout-signature-pad");
            AppState.TempExecution.SignatureBase64 = null;
            StateHasChanged();
        }
        catch { }
    }

    private async Task FinalizeVisitAsync()
    {
        try
        {
            // try to capture current drawing (if any)
            var dataUrl = await JS.InvokeAsync<string>("signature.getDataUrl", "checkout-signature-pad");
            AppState.TempExecution.SignatureBase64 = dataUrl;
        }
        catch { }

        if (string.IsNullOrWhiteSpace(AppState.TempExecution.SignatureBase64))
        {
            ShowAlert("A assinatura é obrigatória para encerrar a visita.");
            return;
        }

        ShowConfirm("Deseja finalizar a visita?", () =>
        {
            AppState.FinishVisit();
            Nav.NavigateTo("/dashboard");
        });
    }

    private void BackToStore()
    {
        // go back to store execution page
        if (StoreId.HasValue)
            Nav.NavigateTo($"/store/{StoreId.Value}");
        else
            Nav.NavigateTo("/dashboard");
    }

    private void ShowAlert(string msg)
    {
        DialogMessage = msg;
        DialogIsConfirm = false;
        ShowDialog = true;
    }

    private void ShowConfirm(string msg, Action onConfirm)
    {
        DialogMessage = msg;
        DialogIsConfirm = true;
        OnDialogConfirm = onConfirm;
        ShowDialog = true;
    }

    private void DialogConfirm()
    {
        ShowDialog = false;
        OnDialogConfirm?.Invoke();
    }

    private void DialogCancel()
    {
        ShowDialog = false;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try { await JS.InvokeVoidAsync("signature.init", "checkout-signature-pad"); } catch { }
        }
    }
}
