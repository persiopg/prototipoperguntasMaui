@page "/checkin/{StoreId:int}"
@using prototipoperguntasMaui.Services
@using Microsoft.AspNetCore.Components.Forms
@using System
@using System.IO
@inject AppStateService AppState
@inject NavigationManager Nav
@inject IJSRuntime JS

<div class="mobile-container flex flex-col min-h-screen">
    @if (CurrentStore != null)
    {
        <div class="sticky top-0 z-40 bg-[#F3F4F6]/95 backdrop-blur-md px-5 py-3 flex justify-between items-center shadow-sm border-b border-white/50 safe-top">
            <button @onclick="BackToDashboard" class="text-slate-500 hover:text-slate-900 flex items-center gap-2 font-bold transition text-sm py-2">
                <div class="w-8 h-8 rounded-full bg-white flex items-center justify-center shadow-sm"><i class="fa-solid fa-chevron-left"></i></div>
                Voltar
            </button>
            <div class="text-xs font-bold text-slate-500">Check-in</div>
        </div>

        <div class="p-5 pb-32 flex-grow">
            <div class="bg-gradient-to-br from-blue-600 to-blue-800 text-white rounded-3xl p-6 mb-8 shadow-xl shadow-blue-200 mt-4 fade-in relative overflow-hidden">
                <div class="absolute -right-6 -top-6 opacity-20 transform rotate-12">
                    <i class="fa-solid fa-store text-[140px]"></i>
                </div>
                <div class="relative z-10">
                    <span class="bg-white/20 px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wide border border-white/20 mb-2 inline-block">@CurrentStore.Channel</span>
                    <h2 class="font-black text-2xl mb-1 leading-none tracking-tight">@CurrentStore.Name</h2>
                    <p class="text-blue-200 text-xs font-medium mt-2 flex items-center gap-2">
                        <i class="fa-solid fa-location-dot"></i> @CurrentStore.Address
                    </p>
                </div>
            </div>

            <div class="app-card">
                <label class="text-xs font-black text-slate-400 uppercase tracking-widest mb-4 block">Selecione a Atividade</label>
                <div class="space-y-3 mb-4">
                    <label class="flex items-center gap-4 p-4 rounded-xl border-2 border-slate-100 cursor-pointer hover:border-blue-500 hover:bg-blue-50 transition-all">
                        <input type="radio" name="activity" value="RESEARCH" @onchange='() => SelectedActivity = "RESEARCH"' class="w-5 h-5 text-blue-600 focus:ring-blue-500" checked="checked">
                        <div>
                            <span class="block text-sm font-bold text-slate-800">Pesquisa de Ciclo</span>
                            <span class="block text-xs text-slate-500">Auditoria completa de itens</span>
                        </div>
                        <i class="fa-solid fa-clipboard-check text-blue-500 ml-auto text-lg"></i>
                    </label>

                    <label class="flex items-center gap-4 p-4 rounded-xl border-2 border-slate-100 cursor-pointer hover:border-emerald-500 hover:bg-emerald-50 transition-all">
                        <input type="radio" name="activity" value="REPLENISHMENT" @onchange='() => SelectedActivity = "REPLENISHMENT"' class="w-5 h-5 text-emerald-600 focus:ring-emerald-500">
                        <div>
                            <span class="block text-sm font-bold text-slate-800">Reposição</span>
                            <span class="block text-xs text-slate-500">Abastecimento e organização</span>
                        </div>
                        <i class="fa-solid fa-boxes-packing text-emerald-500 ml-auto text-lg"></i>
                    </label>

                    <label class="flex items-center gap-4 p-4 rounded-xl border-2 border-slate-100 cursor-pointer hover:border-purple-500 hover:bg-purple-50 transition-all">
                        <input type="radio" name="activity" value="RELATIONSHIP" @onchange='() => SelectedActivity = "RELATIONSHIP"' class="w-5 h-5 text-purple-600 focus:ring-purple-500">
                        <div>
                            <span class="block text-sm font-bold text-slate-800">Relacionamento</span>
                            <span class="block text-xs text-slate-500">Visita de cortesia / Gestão</span>
                        </div>
                        <i class="fa-solid fa-handshake text-purple-500 ml-auto text-lg"></i>
                    </label>

                    <label class="flex items-center gap-4 p-4 rounded-xl border-2 border-slate-100 cursor-pointer hover:border-orange-500 hover:bg-orange-50 transition-all">
                        <input type="radio" name="activity" value="NEGOTIATION" @onchange='() => SelectedActivity = "NEGOTIATION"' class="w-5 h-5 text-orange-600 focus:ring-orange-500">
                        <div>
                            <span class="block text-sm font-bold text-slate-800">Negociação</span>
                            <span class="block text-xs text-slate-500">Acordos comerciais / Sell-in</span>
                        </div>
                        <i class="fa-solid fa-file-signature text-orange-500 ml-auto text-lg"></i>
                    </label>
                </div>

                <h3 class="font-black text-slate-800 text-lg mb-2">Foto da Fachada</h3>
                <p class="text-xs text-slate-500 mb-4">Ao iniciar a visita, o aplicativo vai abrir a câmera para tirar a foto da fachada (seleção de arquivos não é permitida).</p>

                @if (!string.IsNullOrWhiteSpace(PhotoPreviewDataUrl))
                {
                    <div class="mt-5">
                        <img src="@PhotoPreviewDataUrl" class="w-full rounded-2xl border border-slate-100 shadow-sm" />
                    </div>
                } else {
                    <div class="mt-2 text-[11px] text-slate-400">Nenhuma foto registrada ainda. Clique em <strong>INICIAR VISITA</strong> para abrir a câmera.</div>
                }
            </div>
        </div>

        <div class="fixed bottom-0 left-0 right-0 bg-white/95 backdrop-blur-xl p-5 border-t border-slate-100 shadow-[0_-10px_40px_rgba(0,0,0,0.1)] md:max-w-[480px] md:mx-auto z-50 rounded-t-3xl">
            <button @onclick="ConfirmCheckin" class="w-full bg-slate-900 text-white font-bold py-4 rounded-2xl shadow-xl shadow-slate-300 hover:bg-black hover:scale-[1.01] transition-all flex justify-between items-center px-8 group">
                <span class="group-hover:translate-x-1 transition-transform">INICIAR VISITA</span>
                <div class="bg-slate-800 rounded-xl w-8 h-8 flex items-center justify-center group-hover:bg-slate-700 transition-colors border border-slate-700">
                    <i class="fa-solid fa-camera text-sm text-blue-300"></i>
                </div>
            </button>
        </div>
    }
    else
    {
        <div class="p-10 flex flex-col items-center justify-center h-screen">
            <h1 class="text-xl font-bold">Loja não encontrada</h1>
            <button @onclick="BackToDashboard" class="mt-4 bg-blue-500 text-white p-2 rounded">Voltar</button>
        </div>
    }
</div>

@code {
    [Parameter] public int StoreId { get; set; }
    private Store? CurrentStore;
    private string? PhotoPreviewDataUrl;
    private string SelectedActivity { get; set; } = "RESEARCH";
    private bool CanProceed => !string.IsNullOrWhiteSpace(SelectedActivity);
    private bool AutoOpened;

    [Inject] private IServiceProvider ServiceProvider { get; set; } // to access MainThread/MediaPicker via DI if needed (kept for parity)

    protected override void OnInitialized()
    {
        CurrentStore = AppState.Stores.FirstOrDefault(s => s.Id == StoreId);
        if (CurrentStore == null) return;

        if (CurrentStore.Status == "REALIZADO")
        {
            Nav.NavigateTo("/dashboard");
            return;
        }

        if (CurrentStore.Status == "EM_ANDAMENTO")
        {
            AppState.ResumeVisit(StoreId);
            Nav.NavigateTo($"/store/{StoreId}");
        }
    }

    // Removed auto camera open: user chooses activity then takes/selects a photo manually
    protected override Task OnAfterRenderAsync(bool firstRender)
    {
        return Task.CompletedTask;
    }

    private async Task CapturePhotoAndComplete()
    {
        try
        {
            var permission = await Permissions.RequestAsync<Permissions.Camera>();
            if (permission != PermissionStatus.Granted)
            {
                await Shell.Current.DisplayAlertAsync("Permissão", "Permissão de câmera negada.", "OK");
                return;
            }

            if (!MediaPicker.Default.IsCaptureSupported)
            {
                await Shell.Current.DisplayAlertAsync("Erro", "Captura de câmera não suportada neste dispositivo.", "OK");
                return;
            }

            var photo = await MediaPicker.Default.CapturePhotoAsync(new MediaPickerOptions { Title = "Foto da Fachada" });
            if (photo == null)
            {
                await Shell.Current.DisplayAlertAsync("Atenção", "Foto não capturada.", "OK");
                return;
            }

            using var stream = await photo.OpenReadAsync();
            using var ms = new MemoryStream();
            await stream.CopyToAsync(ms);
            var base64 = Convert.ToBase64String(ms.ToArray());
            PhotoPreviewDataUrl = $"data:{photo.ContentType};base64,{base64}";

            // set activity and complete checkin
            AppState.TempExecution.ActivityType = SelectedActivity;
            AppState.CompleteCheckin(StoreId, PhotoPreviewDataUrl);
            Nav.NavigateTo($"/store/{StoreId}");
        }
        catch (Exception ex)
        {
            await Shell.Current.DisplayAlertAsync("Erro", $"Não foi possível abrir a câmera: {ex.Message}", "OK");
        }
    }

    private async Task ConfirmCheckin()
    {
        if (CurrentStore == null || !CanProceed) return;
        await CapturePhotoAndComplete();

        // Save selected activity and complete check-in
        AppState.TempExecution.ActivityType = SelectedActivity;
        AppState.CompleteCheckin(StoreId, PhotoPreviewDataUrl!);
        Nav.NavigateTo($"/store/{StoreId}");
    }

    private void BackToDashboard()
    {
        AppState.CurrentStoreId = null;
        Nav.NavigateTo("/dashboard");
    }
}
